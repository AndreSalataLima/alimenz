<!-- app/views/quotations/_form.html.erb -->
<div data-controller="cotacao">
  <script>
    window.PRODUCTS = <%= raw Product.order(:generic_name).to_json(
      only: [:id, :generic_name, :brand],
      methods: [:unit_options]
    ) %>;
  </script>

  <%= form_with(model: quotation, url: quotations_path, local: true, data: { action: "submit->cotacao#submitForm" }) do |f| %>

    <!-- Produtos selecionados (resumo n√£o edit√°vel) -->
    <div class="my-6">
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Produtos Selecionados</h2>
      <table class="w-full border text-sm">
        <thead>
          <tr class="bg-gray-100">
            <th class="px-2 py-1 text-left">Produto</th>
            <th class="px-2 py-1 text-left">Quantidade</th>
            <th class="px-2 py-1 text-left">Unidade</th>
          </tr>
        </thead>
        <tbody data-cotacao-target="summaryTable"></tbody>
      </table>
    </div>

    <!-- Data de Validade -->
    <div class="mt-6">
      <%= f.label :expiration_date, "Data de validade da cota√ß√£o", class: "block font-medium text-gray-800" %>
      <%= f.date_field :expiration_date, class: "border rounded px-3 py-2 w-full mt-1" %>
      <p class="text-sm text-gray-600 mt-1">Informe uma data futura para a validade da cota√ß√£o.</p>
    </div>

    <!-- Observa√ß√µes Gerais -->
    <div class="mt-6">
      <%= f.label :general_comment, "Observa√ß√µes Gerais", class: "block font-medium text-gray-800" %>
      <%= f.text_area :general_comment, placeholder: "Condi√ß√µes espec√≠ficas de pagamento, faturamento, entrega, comunica√ß√£o ou requisitos especiais", class: "border rounded px-3 py-2 w-full mt-1", rows: 3 %>
    </div>

    <!-- Bot√£o Concluir Cota√ß√£o -->
    <div class="mt-6 hidden" data-cotacao-target="submitButton">
      <%= f.submit "Concluir cota√ß√£o",
        class: "bg-[#615F4A] text-white px-4 py-2 rounded-lg shadow hover:bg-[#4b493f]" %>
    </div>

    <!-- Buscar produto -->
    <div data-controller="product-search" class="my-4">
      <label class="font-medium">Buscar produto:</label>
      <input type="text"
             data-product-search-target="input"
             data-action="input->product-search#filtrar"
             placeholder="Digite o nome do produto"
             class="border rounded px-3 py-2 w-full">
    </div>

    <table class="table-auto w-full border-collapse">
      <thead>
        <tr class="bg-gray-100 border-b">
          <th class="px-2 py-2 text-left">Produto</th>
          <th class="px-2 py-2 text-left">Observa√ß√£o</th>
          <th class="px-2 py-2 text-left">Unidade</th>
          <th class="px-2 py-2 text-left">Quantidade</th>
          <th class="px-2 py-2 text-left"></th>
        </tr>
      </thead>
      <tbody id="itens">
        <% Product.order(:generic_name).each do |product| %>
          <% item = quotation.quotation_items.build(product: product) %>
          <%= f.fields_for :quotation_items, item do |item_form| %>
            <tr class="product-item border-b" data-product-id="<%= product.id %>">
              <td class="px-2 py-2 font-medium" data-controller="custom-name">
                <% customized = current_user.customized_products.find_by(product_id: product.id) %>
                <% nome_personalizado = customized&.custom_name.present? ? customized.custom_name : product.generic_name %>

                <!-- Nome vis√≠vel -->
                <span data-custom-name-target="label" id="product-name-<%= product.id %>">
                  <%= nome_personalizado %>
                </span>

                <!-- Campo de edi√ß√£o com bot√µes -->
                <div class="hidden flex items-center space-x-2" data-custom-name-target="actions">
                  <input type="text"
                         name="customized_products[<%= product.id %>]"
                         value="<%= customized&.custom_name %>"
                         placeholder="<%= product.generic_name %>"
                         class="border rounded px-2 py-1 w-auto"
                         data-custom-name-target="input"
                         data-product-id="<%= product.id %>">

                  <button type="button"
                          class="text-green-600 hover:text-green-800 text-sm"
                          title="Salvar"
                          data-action="click->custom-name#saveClick">
                    üíæ
                  </button>
                  <button type="button"
                          class="text-red-600 hover:text-red-800 text-sm"
                          title="Cancelar"
                          data-action="click->custom-name#cancel">
                    üö´
                  </button>
                </div>

                <!-- Bot√£o l√°pis -->
                <button type="button"
                        class="ml-2 text-gray-500 hover:text-blue-600 text-sm"
                        data-action="click->custom-name#toggle"
                        title="Editar nome do produto"
                        data-custom-name-target="editButton">
                  ‚úèÔ∏è
                </button>

                <!-- Mensagem de status -->
                <div class="text-xs text-green-600 mt-1" data-custom-name-target="status"></div>

                <%= item_form.hidden_field :product_id, value: product.id %>
              </td>

              <td class="px-2 py-2">
                <%= item_form.text_field :product_comment, placeholder: "Especifica√ß√µes do produto.", class: "border rounded px-2 py-1" %>
              </td>

              <td class="px-2 py-2">
                <select name="<%= item_form.object_name %>[selected_unit]"
                        data-cotacao-target="unidadeSelect"
                        class="border rounded px-2 py-1"
                        data-action="change->cotacao#verificarCampos">
                  <option value="">Selecione</option>
                  <% product.unit_options.each do |unit| %>
                    <option value="<%= unit %>"><%= unit %></option>
                  <% end %>
                </select>
              </td>

              <td class="px-2 py-2">
                <%= item_form.number_field :quantity,
                  min: 0, step: 1, value: 0,
                  class: "border rounded px-2 py-1 w-20",
                  data: { action: "input->cotacao#verificarCampos", cotacao_target: "quantidade" } %>
              </td>

              <td class="px-2 py-2">
                <button type="button"
                        class="adicionar-lista-btn text-sm text-blue-600 hidden"
                        data-action="click->cotacao#adicionarProduto">
                  ‚ûï Adicionar
                </button>
              </td>
            </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>

  <% end %>

  <!-- Modal de Erro de Data -->
  <div id="error-modal" data-cotacao-target="errorModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded w-1/3">
      <h3 class="text-lg font-bold mb-2">Aten√ß√£o</h3>
      <p class="mb-4" data-cotacao-target="errorMessage">A data de validade deve ser preenchida e ser futura.</p>
      <button data-action="click->cotacao#fecharErrorModal" class="px-4 py-2 bg-gray-300 rounded">Fechar</button>
    </div>
  </div>

  <!-- Modal de Confirma√ß√£o de Envio -->
  <div id="confirm-modal" data-cotacao-target="confirmModal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-4 rounded w-1/3">
      <h3 class="text-lg font-bold mb-2">Confirma√ß√£o</h3>
      <p class="mb-4">Sua cota√ß√£o est√° conclu√≠da e pronta para ser enviada para os fornecedores?</p>
      <div class="flex justify-end gap-4">
        <button data-action="click->cotacao#cancelSubmit" class="px-4 py-2 bg-gray-300 rounded">Buscar novos produtos</button>
        <button data-action="click->cotacao#confirmSubmit" class="px-4 py-2 bg-[#615F4A] text-white rounded">Enviar</button>
      </div>
    </div>
  </div>
</div>
