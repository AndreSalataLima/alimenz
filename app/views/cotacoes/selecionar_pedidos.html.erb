<h1>Selecione os Itens para Compra</h1>

<p>Revise os valores informados pelos fornecedores para cada item da sua cotação.</p>

<%= form_with url: resumo_pedidos_cotacao_path(@cotacao), method: :post, local: true, data: { turbo: false } do |f| %>
  <input type="hidden" name="cotacao_id" value="<%= @cotacao.id %>">
  <table class="min-w-full divide-y divide-gray-200">
    <thead>
      <tr>
        <th class="px-4 py-2 border">Produto (Item)</th>
        <% @fornecedores.each do |fornecedor| %>
          <th class="px-4 py-2 border"><%= fornecedor.nome %></th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% @itens.each do |item| %>
        <tr>
          <td class="px-4 py-2 border">
            <%= item.produto.nome_generico %> – <%= item.quantidade %> <%= item.unidade_selecionada %>
          </td>
          <% @fornecedores.each do |fornecedor| %>
            <td class="px-4 py-2 border text-center">
              <% resposta = @cotacao.respostas_de_cotacao.find_by(fornecedor_id: fornecedor.id, status: 'finalizado') %>
              <% if resposta.present? %>
                <% preco = resposta.resposta_de_cotacao_items.find_by(item_de_cotacao_id: item.id)&.preco %>
                <p>
                  <%= preco.present? ? number_to_currency(preco.to_f * item.quantidade.to_f) : "Sem preço" %>
                </p>
                <p>
                  <%= check_box_tag "selecionados[#{resposta.id}][#{item.id}]", "1" %>
                  <%= label_tag "selecionados_#{resposta.id}_#{item.id}", "Comprar" %>
                </p>
              <% else %>
                <p>-</p>
              <% end %>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
  <div class="mt-4">
    <%= f.submit "Avançar", class: "bg-blue-500 text-white py-2 px-4 rounded" %>
  </div>
<% end %>
