<%= render 'admin/shared/navbar', titulo: "Detalhes da Resposta de Cota√ß√£o" %>

<div class="container mx-auto py-6 px-4">
  <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-xl p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Resposta da Cota√ß√£o #<%= @resposta.id %></h2>

    <div class="space-y-4">
      <p><strong>Fornecedor:</strong> <%= @resposta.fornecedor.nome %></p>
      <p><strong>Status do Fornecedor:</strong> <%= @resposta.status.capitalize %></p>
      <p><strong>Status da An√°lise:</strong>
        <% if @resposta.status_analise == "pendente_de_analise" %>
          <span class="px-2 py-1 text-sm font-medium text-yellow-700 bg-yellow-100 rounded-full">
            üü° Pendente de An√°lise
          </span>
        <% elsif @resposta.status_analise == "aprovado" %>
          <span class="px-2 py-1 text-sm font-medium text-green-700 bg-green-100 rounded-full">
            ‚úÖ Aprovado
          </span>
        <% elsif @resposta.status_analise == "cotacao_nao_aceita" %>
          <span class="px-2 py-1 text-sm font-medium text-red-700 bg-red-100 rounded-full">
            ‚ùå Cota√ß√£o n√£o aceita
          </span>
        <% else %>
          <span class="px-2 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded-full">
            -
          </span>
        <% end %>
      </p>
      <p><strong>Data de Validade:</strong> <%= @resposta.data_validade.strftime("%d/%m/%Y") if @resposta.data_validade %></p>

      <% if @resposta.status == "finalizado" && @resposta.documento_assinado.attached? %>
        <div class="mt-4">
          <strong>Documento Enviado:</strong>
          <%= link_to "üìÑ Visualizar PDF", rails_blob_path(@resposta.documento_assinado, disposition: "inline"), target: "_blank", class: "text-blue-600 hover:underline" %>
        </div>
      <% else %>
        <p class="text-red-500 mt-4">‚ùå Nenhum documento enviado ou resposta n√£o finalizada.</p>
      <% end %>
    </div>

    <h3 class="text-xl font-semibold text-gray-700 mt-6">Itens da Cota√ß√£o</h3>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200 mt-2">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-4 py-2 text-left">Produto</th>
            <th class="px-4 py-2 text-left">Quantidade</th>
            <th class="px-4 py-2 text-left">Unidade</th>
            <th class="px-4 py-2 text-left">Pre√ßo</th>
            <th class="px-4 py-2 text-left">Dispon√≠vel?</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <% @resposta.resposta_de_cotacao_items.each do |item| %>
            <tr class="hover:bg-gray-50">
              <td class="px-4 py-2"><%= item.item_de_cotacao.produto.nome_generico %></td>
              <td class="px-4 py-2"><%= item.item_de_cotacao.quantidade %></td>
              <td class="px-4 py-2"><%= item.item_de_cotacao.unidade_selecionada %></td>
              <td class="px-4 py-2">
                <% if item.disponivel %>
                  <span class="text-green-700 font-semibold">R$ <%= number_with_precision(item.preco, precision: 2) %></span>
                <% else %>
                  <span class="text-red-600">Indispon√≠vel</span>
                <% end %>
              </td>
              <td class="px-4 py-2 text-center">
                <% if item.disponivel %>
                  ‚úÖ
                <% else %>
                  ‚ùå
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <h3 class="text-xl font-semibold text-gray-700 mt-6">Checklist de Valida√ß√£o</h3>
    <p class="text-gray-600">Marque os itens que est√£o de acordo:</p>

    <div data-controller="approval">
      <%= form_with id: "checklistForm", url: aprovar_admin_resposta_de_cotacao_path(@resposta), method: :patch, local: true do |f| %>
        <div class="space-y-2">
          <%= f.check_box :check_carimbo, { id: "check_carimbo" }, "1", "0" %>
          <%= f.label :check_carimbo, "Carimbo e assinaturas leg√≠veis" %><br>

          <%= f.check_box :check_data, { id: "check_data" }, "1", "0" %>
          <%= f.label :check_data, "Data de validade v√°lida" %><br>

          <%= f.check_box :check_produtos, { id: "check_produtos" }, "1", "0" %>
          <%= f.label :check_produtos, "Produtos correspondem √† cota√ß√£o" %><br>

          <%= f.check_box :check_valores, { id: "check_valores" }, "1", "0" %>
          <%= f.label :check_valores, "Valores individuais batem com o documento" %>
        </div>

        <div class="mt-4">
          <button type="button" data-action="click->approval#selecionarTodos" class="bg-gray-300 px-3 py-1 rounded">Selecionar Todos</button>
        </div>

        <div class="mt-6 flex space-x-4">
          <button type="button" id="btnAprovar" data-action="click->approval#showAprovarModal" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700">Aprovar Cota√ß√£o</button>
          <button type="button" id="btnReprovar" data-action="click->approval#showReprovarModal" data-action-url="<%= reprovar_admin_resposta_de_cotacao_path(@resposta) %>" class="bg-red-600 text-white px-4 py-2 rounded shadow hover:bg-red-700">Reprovar Cota√ß√£o</button>
        </div>
      <% end %>
    </div>

    <!-- Modal de Aprova√ß√£o -->
    <div id="modalAprovar" data-approval-target="modalAprovar" class="hidden fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50">
      <div class="bg-white p-6 rounded w-1/3 shadow-lg">
        <h2 class="text-lg font-bold mb-2">Confirmar Aprova√ß√£o</h2>
        <p>Tem certeza que deseja aprovar esta cota√ß√£o?</p>
        <div class="mt-4 flex justify-end space-x-4">
          <button type="button" data-action="click->approval#confirmarAprovacao" class="bg-green-500 text-white px-4 py-2 rounded">Aprovar</button>
          <button type="button" data-action="click->approval#cancelarAprovacao" class="bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
</div>
